<!DOCTYPE html>
<meta charset="utf-8">
  <head>
    <title>BigWig Test</title>
    <script type="text/javascript" src="./require.js"></script>
  </head>

  <body>
      <div id="vis"></div>
  </body>

<script type="text/javascript">
    // Map from jquery.min to jquery.
    requirejs.config({
        baseUrl: '.',
        paths: {
            jquery: 'jquery.min'
        }
    });

    require(['bigwig', 'd3.min', 'vega', 'numerical'], function(bigwig, d3, vega, numerical) {
        /**
         * Draw line chart for bigwig data.
         */
        var drawIntensityChart = function(data) {
            var converted_data = $.map(data, function(interval) {
                if (interval.min === interval.max) {
                    return {
                        start: interval.min,
                        end: interval.min + 1,
                        score: interval.score
                    };
                }
                else {
                    return {
                        start: interval.min,
                        end: interval.max,
                        score: interval.score
                    };
                }
            });

            $.getJSON("./chart_defs/intensity.json", function(viz_spec) {
                viz_spec.data = [
                    {
                        "name": "table",
                        "values": converted_data
                    }
                ];
                vega.parse.spec(viz_spec, function(chart) {
                    chart({el:"#vis", renderer: "svg"}).update();
                });
            });
        };

        /**
         * Benchmarking function that prints the number of data points returned at each zoom level.
         */
        var benchmarkZoomLevels = function(bb) {
            $.each([0,1,2,3,4,5,6,7,8,9], function(zl) {
                $.when(bb.getZoomedView(zl).readWigData(1, 0, 249250620)).then(function(data) {
                    console.log("zoom level", zl, data.length);
                });
            });
            $.when(bb.getUnzoomedView().readWigData(1, 0, 249250620)).then(function(data) {
                console.log("unzoomed    ", data.length);
            });
        };

        //
        // Read file and display results.
        //

        var readData = function(url, chrom, start, end) {
            var promise = new $.Deferred();
            $.when(bigwig.makeBwg(url)).then(function(bb, err) {
                $.when(bb.readWigData(chrom, start, end)).then(function(data) {
                    $('body').append("<h3>Information about " + url + "</h3>");
                    $('body').append("Version: " + bb.version + "<br>");
                    $('body').append("Number of Zoom Levels: " + bb.numZoomLevels + "<br>");

                    $('body').append("Length: "+ data.length +"<br>");
                    $('body').append("readWigData:<br>");
                    $('body').append($.map(data, function(interval){ return interval.min + " " + interval.max + " " + Math.round(interval.score); }).join('<br>'));
                    $('body').append("<br>");
                    //benchmarkZoomLevels(bb);

                    promise.resolve(data);
                });
            });

            return promise;
        };

        var bbURI = [
            "chr19.normal.bw",
            "chr19.tumor.bw"
        ]; //"RMNISTHS_30xdownsample.bigwig"; // 'hg19.100way.phyloP100way.bw'; //'./miapaca2_rnaseq.bigwig'; // './hg19_refgene.bb'; // 'RMNISTHS_30xdownsample.bigwig';
        $.when(readData(bbURI[0], 19, 0, 30000000), readData(bbURI[1], 19, 0, 30000000)).then(function(data1, data2) {
            numerical.drawLineChart(
                // Datasets.
                [
                {
                    name: "normal",
                    data: data1,
                    color: 'blue'
                },
                {
                    name: "tumor",
                    data: data2,
                    color: 'red'
                }
                ],
                // Visualization-level properties.
                {
                    ydomain: [0, 100]
                }
            );
        });
    });
</script>
